<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DungeonMasterAI</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background-color: #2c2c2c;
            padding: 10px 20px;
            border-bottom: 2px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #4CAF50;
            font-size: 24px;
        }
        
        .location-info {
            color: #FFA500;
            font-size: 14px;
            font-family: 'Courier New', Courier, monospace;
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .location-name {
            font-weight: bold;
            color: #4CAF50;
        }
        
        .location-details {
            color: #888;
            font-size: 12px;
            margin-top: 2px;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #555;
        }
        
        .status-indicator.connected {
            background-color: #4CAF50;
        }
        
        .main-container {
            display: flex;
            flex: 1;
            height: calc(100vh - 60px);
        }
        
        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #444;
            margin: 10px;
            background-color: #2c2c2c;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .panel-header {
            background-color: #333;
            padding: 10px;
            font-weight: bold;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        /* Dice Rolling Strip - Inline with header */
        .dice-strip-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .dice-label {
            color: #FFA500;
            font-weight: bold;
            font-size: 14px;
            margin-right: 5px;
        }
        
        .dice-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: background-color 0.3s;
            min-width: 50px;
        }
        
        .dice-button:hover {
            background-color: #45a049;
        }
        
        .dice-clear-button {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-left: 10px;
        }
        
        .dice-clear-button:hover {
            background-color: #da190b;
        }
        
        .dice-results {
            background-color: #1a1a1a;
            border-bottom: 1px solid #444;
            padding: 8px 10px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            color: #e0e0e0;
        }
        
        .dice-result-item {
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 3px;
        }
        
        .dice-total {
            color: #FFA500;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Inventory Panel Content - Special Layout */
        #inventory-tab .panel-content {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 10px;
        }
        
        /* Debug Panel Content - Auto-scroll to bottom */
        #debug-output {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            min-height: 100%;
            font-size: 12px;
        }
        
        #debug-output .message {
            flex-shrink: 0;
        }
        
        .game-panel {
            flex: 2;
        }
        
        .debug-panel {
            flex: 1;
            max-width: 500px;
        }
        
        .input-container {
            display: flex;
            padding: 10px;
            background-color: #333;
            border-top: 1px solid #444;
        }
        
        .input-field {
            flex: 1;
            padding: 8px 12px;
            background-color: #1a1a1a;
            border: 1px solid #444;
            color: #e0e0e0;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
        }
        
        .send-button {
            margin-left: 10px;
            padding: 8px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .send-button:hover {
            background-color: #45a049;
        }
        
        .send-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        .start-button {
            padding: 8px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .start-button:hover {
            background-color: #1976D2;
        }
        
        .save-load-buttons {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        
        .save-button, .load-button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .save-button {
            background-color: #FF9800;
        }
        
        .save-button:hover {
            background-color: #F57C00;
        }
        
        .load-button {
            background-color: #9C27B0;
        }
        
        .load-button:hover {
            background-color: #7B1FA2;
        }
        
        .save-load-buttons button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        /* Save/Restore Dialog Styles */
        .save-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .save-dialog {
            background-color: #2c2c2c;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 20px;
            min-width: 400px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .save-dialog h3 {
            color: #4CAF50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .save-form {
            margin-bottom: 20px;
        }
        
        .save-form label {
            display: block;
            margin-bottom: 5px;
            color: #e0e0e0;
        }
        
        .save-form input, .save-form select, .save-form textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background-color: #333;
            border: 1px solid #555;
            color: #e0e0e0;
            border-radius: 4px;
        }
        
        .save-form textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .save-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #333;
        }
        
        .save-item {
            padding: 10px;
            border-bottom: 1px solid #555;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .save-item:hover {
            background-color: #3a3a3a;
        }
        
        .save-item.selected {
            background-color: #4CAF50;
            color: white;
        }
        
        .save-item-header {
            font-weight: bold;
            color: #4CAF50;
        }
        
        .save-item-details {
            font-size: 12px;
            color: #ccc;
            margin-top: 5px;
        }
        
        .dialog-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }
        
        .dialog-button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .dialog-button.primary {
            background-color: #4CAF50;
        }
        
        .dialog-button.primary:hover {
            background-color: #45a049;
        }
        
        .dialog-button.secondary {
            background-color: #666;
        }
        
        .dialog-button.secondary:hover {
            background-color: #555;
        }
        
        .dialog-button.danger {
            background-color: #f44336;
        }
        
        .dialog-button.danger:hover {
            background-color: #da190b;
        }
        
        /* Clean Tavern AI Style Messages */
        .message {
            display: flex;
            align-items: flex-start;
            margin: 20px 0;
            max-width: 100%;
            word-wrap: break-word;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            overflow: hidden;
        }
        
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .message-content {
            flex: 1;
            min-width: 0;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .message-author {
            font-weight: bold;
            font-size: 16px;
            margin-right: 8px;
        }
        
        .message-badge {
            background: #4a90e2;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .message-text {
            line-height: 1.6;
            white-space: pre-wrap;
            font-size: 17px;
        }
        
        /* DM Messages */
        .message.narration .message-avatar {
            background: #8b4513;
        }
        
        .message.narration .message-author {
            color: #ffb347;
        }
        
        .message.narration .message-text {
            color: #ffa500;
        }
        
        /* Player Messages */
        .message.user-input .message-avatar {
            background: #4a90e2;
        }
        
        .message.user-input .message-author {
            color: #4a90e2;
        }
        
        .message.user-input .message-text {
            color: #e8e8e8;
        }
        
        /* System Messages */
        .message.system {
            justify-content: center;
            margin: 15px 0;
        }
        
        .message.system .message-content {
            background: #2a2a2a;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #444;
            text-align: center;
            max-width: 500px;
        }
        
        .message.system .message-text {
            color: #aaa;
            font-style: italic;
            font-size: 13px;
        }
        
        /* Error Messages */
        .message.error {
            justify-content: center;
            margin: 15px 0;
        }
        
        .message.error .message-content {
            background: #5a2d2d;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #8b3333;
            text-align: center;
            max-width: 500px;
        }
        
        .message.error .message-text {
            color: #ffaaaa;
            font-size: 13px;
        }
        
        /* Debug Messages (only in debug panel) */
        .message.debug {
            margin: 5px 0;
            font-size: 12px;
        }
        
        .message.debug .message-content {
            background: #1a1a1a;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #333;
        }
        
        .message.debug .message-text {
            color: #888;
        }
        
        .message.debug.error .message-text {
            color: #ff6b6b;
        }
        
        .timestamp {
            color: #666;
            font-size: 0.8em;
            margin-right: 10px;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        /* Tab styling */
        .tabs {
            display: flex;
            background-color: #333;
            border-bottom: 1px solid #444;
        }
        
        .tab-button {
            flex: 1;
            padding: 10px;
            background-color: #333;
            color: #888;
            border: none;
            border-right: 1px solid #444;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab-button:last-child {
            border-right: none;
        }
        
        .tab-button:hover {
            background-color: #3a3a3a;
            color: #e0e0e0;
        }
        
        .tab-button.active {
            background-color: #2c2c2c;
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
        }
        
        .tab-content {
            height: calc(100% - 41px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: #1a1a1a;
        }
        
        /* MODIFIED */
        #stats-content {
            padding: 0 !important; /* Ensure no top padding */
            background-color: #0a0a0a;
            overflow: hidden;
            display: block; /* Ensure block display to prevent flex centering of child */
        }
        
        /* MODIFIED */
        .character-sheet-wrapper {
            transform-origin: top left;
            transition: transform 0.3s ease;
            display: block; /* Explicitly set display type */
            margin: 0;      /* Remove any potential default margins */
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
            font-style: italic;
        }
        
        /* Inventory styling - modern design matching character sheet */
        .inventory-sheet {
            padding: 8px;
            margin: 0;
            background-color: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            font-family: 'Crimson Text', Georgia, serif;
            background-image: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(255, 255, 255, 0.01) 10px,
                    rgba(255, 255, 255, 0.01) 20px
                );
        }
        
        .inventory-header {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 2px solid #666;
        }
        
        .currency-display {
            text-align: center;
        }
        
        .currency-title {
            font-size: 24px;
            font-weight: 600;
            color: #FFA500;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Cinzel', Georgia, serif;
            margin-bottom: 8px;
        }
        
        .currency-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .currency-item {
            background-color: #2c2c2c;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 4px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .currency-amount {
            font-size: 28px;
            font-weight: bold;
            color: #4CAF50;
            line-height: 1;
        }
        
        .currency-type {
            font-size: 14px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .currency-total {
            font-size: 16px;
            color: #FFA500;
            font-style: italic;
            margin-top: 4px;
        }
        
        .equipment-section {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 6px;
            margin-bottom: 8px;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        .equipment-section h3 {
            margin: 0 0 8px 0;
            color: #FFA500;
            border-bottom: 1px solid #444;
            padding-bottom: 4px;
            position: sticky;
            top: 0;
            background-color: #2c2c2c;
            z-index: 1;
        }
        
        .inventory-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: auto;
            flex-shrink: 0;
        }
        
        .inventory-section {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 6px;
            margin: 0;
        }
        
        .inventory-section h3, .inventory-section h4 {
            margin: 0 0 6px 0;
            color: #FFA500;
            border-bottom: 1px solid #444;
            padding-bottom: 3px;
            text-transform: uppercase;
            font-size: 16px;
            letter-spacing: 1px;
            font-family: 'Cinzel', Georgia, serif;
            position: sticky;
            top: 0;
            background-color: #2c2c2c;
            z-index: 1;
        }
        
        .inventory-item {
            padding: 3px 0;
            border-bottom: 1px solid #222;
            font-size: 14px;
        }
        
        .inventory-item:last-child {
            border-bottom: none;
        }
        
        .inventory-item:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        .item-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }
        
        .item-name {
            color: #4CAF50;
            font-weight: bold;
            font-size: 17px;
        }
        
        .item-qty {
            color: #999;
            font-size: 14px;
            font-style: italic;
        }
        
        .weapon-bonus {
            color: #ff8c00;
            font-weight: bold;
            font-size: 16px;
        }
        
        .item-details {
            font-size: 12px;
            color: #bbb;
            line-height: 1.3;
        }
        
        .item-type {
            color: #777;
            font-style: italic;
            text-transform: capitalize;
        }
        
        .weapon-damage {
            color: #ff8c00;
            font-weight: bold;
            font-size: 15px;
        }
        
        .item-desc {
            color: #ccc;
            margin-top: 1px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Inventory Controls - Compact Single Line */
        .inventory-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 8px 0;
            padding: 6px 12px;
            background-color: #333;
            border-radius: 4px;
            border: 1px solid #444;
            font-size: 13px;
        }
        
        .search-btn, .inventory-sort, .filter-dropdown {
            padding: 4px 8px;
            background-color: #2c2c2c;
            border: 1px solid #555;
            border-radius: 3px;
            color: #e0e0e0;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .search-btn:hover, .inventory-sort:hover, .filter-dropdown:hover {
            background-color: #3a3a3a;
            border-color: #666;
        }
        
        
        /* Search Popup Modal */
        .search-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .search-popup-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2c2c2c;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #444;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .search-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .search-popup-title {
            color: #4CAF50;
            font-size: 16px;
            font-weight: bold;
        }
        
        .search-popup-close {
            color: #888;
            font-size: 24px;
            cursor: pointer;
            padding: 0 5px;
        }
        
        .search-popup-close:hover {
            color: #e0e0e0;
        }
        
        .search-popup-input {
            width: 300px;
            padding: 8px 12px;
            background-color: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
        }
        
        .search-popup-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        /* Spells & Magic Items styling */
        .spells-magic-sheet {
            padding: 8px;
            margin: 0;
            background-color: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            font-family: 'Crimson Text', Georgia, serif;
            background-image: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(255, 255, 255, 0.01) 10px,
                    rgba(255, 255, 255, 0.01) 20px
                );
        }
        
        .spellcasting-section {
            margin-bottom: 10px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 8px;
        }
        
        .spellcasting-section h3 {
            margin: 0 0 8px 0;
            color: #FFA500;
            border-bottom: 1px solid #444;
            padding-bottom: 4px;
            text-transform: uppercase;
            font-size: 18px;
            letter-spacing: 1px;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .spell-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            padding: 6px;
            background-color: #1a1a1a;
            border-radius: 4px;
        }
        
        .spell-stats span {
            color: #FFA500;
            font-weight: bold;
            font-size: 14px;
        }
        
        .spell-level-group {
            margin-bottom: 8px;
            background-color: #1a1a1a;
            border-radius: 4px;
            padding: 6px;
        }
        
        .spell-level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            border-bottom: 1px solid #444;
            padding-bottom: 2px;
        }
        
        .spell-level-name {
            color: #4CAF50;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .spell-slots {
            font-size: 12px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            background-color: #333;
        }
        
        .spell-slots.available {
            color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.2);
        }
        
        .spell-slots.low {
            color: #FF9800;
            background-color: rgba(255, 152, 0, 0.2);
        }
        
        .spell-slots.exhausted {
            color: #f44336;
            background-color: rgba(244, 67, 54, 0.2);
        }
        
        .spell-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }
        
        .spell-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2px 4px;
            background-color: #333;
            border-radius: 3px;
            font-size: 13px;
            transition: background-color 0.2s;
        }
        
        .spell-item:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        .spell-name {
            color: #e0e0e0;
            flex: 1;
        }
        
        .spell-badges {
            display: flex;
            gap: 2px;
            margin-left: 4px;
        }
        
        .spell-badge {
            font-size: 9px;
            padding: 1px 3px;
            border-radius: 2px;
            color: white;
            font-weight: bold;
        }
        
        .spell-badge.ritual {
            background-color: #2196F3;
        }
        
        .spell-badge.concentration {
            background-color: #FF9800;
        }
        
        .spell-badge.prepared {
            background-color: #4CAF50;
        }
        
        .magic-items-section {
            margin-top: 10px;
        }
        
        .magic-items-category {
            margin-bottom: 8px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 6px;
        }
        
        .magic-items-category h4 {
            margin: 0 0 6px 0;
            color: #FFA500;
            border-bottom: 1px solid #444;
            padding-bottom: 3px;
            text-transform: uppercase;
            font-size: 16px;
            letter-spacing: 1px;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .magic-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 3px 4px;
            margin: 2px 0;
            background-color: #1a1a1a;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .magic-item:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        .magic-item-name {
            color: #4CAF50;
            font-weight: bold;
            flex: 1;
        }
        
        .magic-item-charges {
            font-size: 12px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }
        
        .magic-item-charges.available {
            color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.2);
        }
        
        .magic-item-charges.low {
            color: #FF9800;
            background-color: rgba(255, 152, 0, 0.2);
        }
        
        .magic-item-charges.exhausted {
            color: #f44336;
            background-color: rgba(244, 67, 54, 0.2);
        }
        
        .magic-item-charges.consumable {
            color: #fff;
            background-color: #666;
        }
        
        .no-spellcasting-message {
            text-align: center;
            padding: 20px;
            color: #888;
            font-style: italic;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        /* Character Sheet Styling */
        .character-sheet {
            padding: 8px;
            margin: 0;
            background-color: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            font-family: 'Crimson Text', Georgia, serif;
            background-image: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(255, 255, 255, 0.01) 10px,
                    rgba(255, 255, 255, 0.01) 20px
                );
        }
        
        /* MODIFIED */
        .character-header {
            margin: 0;
            padding: 0 0 3px 0;
            border-bottom: 2px solid #666;
        }
        
        /* MODIFIED */
        .character-details {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            color: #ccc;
            font-size: 16px;
            line-height: 1.2;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* ADDED */
        .character-details > .detail-left > div,
        .character-details > .detail-right > div {
            margin-bottom: 2px; /* Small gap between lines in each column */
            min-height: 1.3em; /* Ensure lines take up similar space for better cross-alignment */
        }
        
        /* ADDED */
        .character-details > .detail-left > div:last-child,
        .character-details > .detail-right > div:last-child {
            margin-bottom: 0; /* No margin for the last line in each column */
        }
        
        .detail-left {
            flex: 1;
        }
        
        .detail-right {
            text-align: right;
        }
        
        .orange {
            color: #FFA500;
            font-weight: bold;
        }
        
        /* MODIFIED */
        .character-name {
            font-size: 32px;
            font-weight: 600;
            color: #FFA500;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Cinzel', Georgia, serif;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            line-height: 1;
            margin: 0 !important;
            padding: 0 !important;
            border: 0;
            outline: 0;
            vertical-align: baseline;
            background: transparent;
        }
        
        /* Ability Scores */
        /* MODIFIED */
        .abilities-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
            margin-top: 3px; /* Ensure it's not too far from details */
            margin-bottom: 3px; /* Reduced */
        }
        
        .ability-score {
            background-color: #2c2c2c;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 2px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .ability-score:hover {
            border-color: #FFA500;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 165, 0, 0.2);
        }
        
        .ability-name {
            font-size: 18px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
            line-height: 1;
        }
        
        .ability-value {
            font-size: 36px;
            font-weight: bold;
            color: #e0e0e0;
            margin: 0;
            line-height: 0.9;
        }
        
        .ability-modifier {
            font-size: 20px;
            color: #FFA500;
            border: 1px solid #FFA500;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            background-color: rgba(255, 165, 0, 0.1);
            font-weight: bold;
        }
        
        /* Combat Stats */
        .combat-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
            margin-bottom: 0;
        }
        
        .combat-stat {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 3px;
            text-align: center;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .combat-stat::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #FFA500, #444);
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: -1;
        }
        
        .combat-stat:hover::before {
            opacity: 0.1;
        }
        
        .combat-stat-label {
            font-size: 14px;
            color: #888;
            text-transform: uppercase;
            margin: 0;
            line-height: 1;
        }
        
        .combat-stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #4CAF50;
            line-height: 1;
            margin: 2px 0;
        }
        
        .hp-bar {
            background-color: #1a1a1a;
            border: 1px solid #444;
            border-radius: 3px;
            height: 6px;
            margin-top: 1px;
            overflow: hidden;
        }
        
        .hp-fill {
            background-color: #4CAF50;
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .hp-fill.low {
            background-color: #f44336;
        }
        
        .hp-fill.medium {
            background-color: #ff9800;
        }
        
        /* Skills and Saves */
        .skills-saves-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 0;
            margin-bottom: 3px;
        }
        
        .stat-group {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 2px;
            margin: 0;
        }
        
        .stat-group h4 {
            margin: 0 0 2px 0;
            color: #FFA500;
            border-bottom: 1px solid #444;
            padding: 2px 0 2px 0;
            text-transform: uppercase;
            font-size: 18px;
            letter-spacing: 1px;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .save-item, .skill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1px 2px;
            margin: 0;
            font-size: 21px;
            line-height: 1;
        }
        
        .save-item:hover, .skill-item:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        .save-name, .skill-name {
            color: #aaa;
            font-size: 21px;
        }
        
        .save-value, .skill-value {
            color: #e0e0e0;
            font-weight: bold;
            font-size: 21px;
        }
        
        .stat-group-content {
            padding-right: 0;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        
        
        /* Features and Abilities */
        .features-section {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 3px;
            margin-bottom: 3px;
        }
        
        .features-section h4 {
            margin: 0 0 2px 0;
            color: #FFA500;
            border-bottom: 1px solid #444;
            padding-bottom: 2px;
            text-transform: uppercase;
            font-size: 24px;
            letter-spacing: 1px;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .features-abilities-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 3px;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            padding: 2px 4px;
            margin: 0;
            font-size: 16px;
            line-height: 1.2;
            cursor: help;
            transition: background-color 0.2s;
        }
        
        .feature-item:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        /* New Abilities Grid Layout */
        .abilities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 5px;
            margin-top: 3px;
        }
        
        /* Usage Tracking Styles */
        .feature-item.with-usage {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .feature-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .usage-counter {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .usage-counter.exhausted {
            background-color: #f44336;
        }
        
        .feature-refresh {
            font-size: 16px;
            color: #888;
            font-style: italic;
            margin-left: 8px;
        }
        
        /* Effect Item Styles */
        .effect-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 3px 4px;
            margin: 1px 0;
            font-size: 14px;
            line-height: 1.2;
            cursor: help;
            transition: background-color 0.2s;
        }
        
        .effect-item:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        .effect-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .effect-duration {
            font-size: 16px;
            color: #FFA500;
            font-style: italic;
            margin-left: 8px;
        }
        
        .effect-duration.expired {
            color: #f44336;
        }
        
        .effect-type {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }
        
        /* Effect Badges */
        .effect-badge {
            font-size: 10px;
            padding: 2px 4px;
            margin: 1px;
            border-radius: 3px;
            background-color: #666;
            color: white;
            font-weight: bold;
        }
        
        .effect-badge.resistance {
            background-color: #2196F3;
        }
        
        .effect-badge.bonus {
            background-color: #4CAF50;
        }
        
        /* Health & Conditions Section */
        .health-status-section {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 8px;
            margin: 5px 0;
        }
        
        .health-status-section h4 {
            margin: 0 0 8px 0;
            color: #FFA500;
            border-bottom: 1px solid #444;
            padding-bottom: 4px;
            text-transform: uppercase;
            font-size: 18px;
            letter-spacing: 1px;
            font-family: 'Cinzel', Georgia, serif;
        }
        
        .conditions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .condition-category h5 {
            margin: 0 0 4px 0;
            color: #ccc;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .condition-item {
            display: flex;
            align-items: center;
            padding: 3px 4px;
            margin: 1px 0;
            font-size: 13px;
            line-height: 1.2;
            cursor: help;
            transition: background-color 0.2s;
        }
        
        .condition-item:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        .condition-badge {
            font-size: 9px;
            padding: 1px 3px;
            margin-right: 4px;
            border-radius: 2px;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .condition-badge.resistance {
            background-color: #2196F3;
        }
        
        .condition-badge.immunity {
            background-color: #4CAF50;
        }
        
        .condition-badge.vulnerability {
            background-color: #f44336;
        }
        
        .healing-requirement {
            font-size: 10px;
            color: #FFA500;
            font-style: italic;
            margin-left: 4px;
        }
        
        .condition-item.injury {
            border-left: 3px solid #f44336;
            padding-left: 6px;
        }
        
        /* Equipment Effects Styling */
        .feature-item.equipment-effect {
            padding: 2px 0;
        }
        
        .feature-bullet {
            color: #FFA500;
            margin-right: 6px;
            font-size: 14px;
        }
        
        .feature-name {
            color: #e0e0e0;
            font-size: 16px;
        }
        
        /* --- NPC STYLING REFINEMENTS --- */
        .npc-character-sheet {
            margin-bottom: 20px;
            padding: 8px;
            background-color: #2c2c2c;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            font-family: 'Crimson Text', Georgia, serif;
        }
        
        .npc-header {
            display: flex;
            justify-content: flex-start; /* MODIFIED: Keeps items together */
            align-items: center;       /* MODIFIED: Vertically aligns items */
            gap: 10px;                 /* MODIFIED: Adds space between boxes */
            margin: 0;
            padding: 0 0 8px 0;
            border-bottom: 2px solid #444;
        }

        .npc-header-main {
            flex-grow: 1; /* MODIFIED: Takes up available space */
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 6px 10px;
        }
        
        .npc-header-currency {
            flex-shrink: 0; /* MODIFIED: Prevents currency box from shrinking */
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 4px;
        }
        
        .npc-header-currency .currency-grid {
            gap: 5px;
        }

        .npc-header-currency .currency-item {
            padding: 2px 4px;
            background-color: #2c2c2c;
            border: 1px solid #444;
        }

        .npc-header-currency .currency-amount {
            font-size: 16px;
        }

        .npc-header-currency .currency-type {
            font-size: 10px;
        }
        
        .npc-name {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
            margin: 0;
            font-family: 'Cinzel', Georgia, serif;
            line-height: 1;
        }
        
        .npc-details {
            font-size: 13px;
            color: #ccc;
            font-style: italic;
            line-height: 1.1;
            margin: 0;
        }
        
        .npc-abilities {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
            gap: 4px;
            margin: 8px 0;
            background-color: #1a1a1a;
            border-radius: 5px;
            padding: 6px;
        }
        
        .npc-abilities .ability-score {
            text-align: center;
            background-color: #333;
            border-radius: 5px;
            padding: 4px 2px;
            min-width: 40px;
            font-size: 12px;
        }
        
        .npc-abilities .ability-name {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
            line-height: 1;
        }
        
        .npc-abilities .ability-value {
            font-size: 18px;
            font-weight: bold;
            color: #e0e0e0;
            margin: 1px 0;
            line-height: 0.9;
        }
        
        .npc-abilities .ability-modifier {
            font-size: 12px;
            color: #FFA500;
            border: 1px solid #FFA500;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 2px auto 0;
            background-color: rgba(255, 165, 0, 0.1);
            font-weight: bold;
        }
        
        .npc-abilities .npc-combat-stat {
            background-color: #2c2c2c;
            border: 1px solid #4CAF50;
        }
        
        .npc-abilities .npc-combat-stat .ability-name {
            color: #4CAF50;
            font-weight: bold;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        .npc-abilities .npc-combat-stat .ability-value {
            font-size: 14px;
            color: #4CAF50;
        }
        
        .npc-abilities .npc-combat-stat.npc-no-circle .ability-value {
            font-size: 20px;
            font-weight: bold;
        }
        
        .npc-abilities .hp-bar {
            background-color: #1a1a1a;
            border: 1px solid #444;
            border-radius: 2px;
            height: 4px;
            margin: 2px auto 0 auto;
            overflow: hidden;
            width: 90%;
        }
        
        .npc-abilities .hp-fill {
            background-color: #4CAF50;
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .npc-abilities .hp-fill.healthy {
            background-color: #4CAF50;
        }
        
        .npc-abilities .hp-fill.injured {
            background-color: #ff9800;
        }
        
        .npc-abilities .hp-fill.bloodied {
            background-color: #ff5722;
        }
        
        .npc-abilities .hp-fill.critical {
            background-color: #f44336;
        }
        
        .npc-abilities .npc-no-circle .ability-modifier {
            display: none;
        }
        
        .npc-skills-saves-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 10px 0;
        }
        
        .npc-detail-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: background-color 0.3s;
            width: 100%;
        }
        
        .npc-detail-button:hover {
            background-color: #45a049;
        }
        
        .npc-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }
        
        .npc-details-modal-content {
            position: relative;
            background-color: #2c2c2c;
            margin: 10% auto;
            padding: 20px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            max-height: 70%;
            overflow: hidden;
        }
        
        .npc-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
        }
        
        .npc-details-title {
            color: #4CAF50;
            font-size: 18px;
            font-weight: bold;
        }
        
        .npc-details-close {
            color: #aaa;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .npc-details-close:hover {
            color: #fff;
        }
        
        .npc-details-body {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .npc-details-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 4px;
            background-color: #1a1a1a;
            border-radius: 4px;
            cursor: help;
        }
        
        .npc-details-name {
            color: #e0e0e0;
            font-weight: bold;
        }
        
        .npc-details-bonus {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .npc-details-proficient {
            color: #FFA500;
            margin-left: 8px;
        }
        
        .npc-spellcasting {
            margin: 10px 0;
            background-color: #1a1a1a;
            border-radius: 5px;
            padding: 8px;
        }
        
        .npc-spellcasting h4 {
            color: #4CAF50;
            font-size: 16px;
            margin-bottom: 6px;
            border-bottom: 1px solid #444;
            padding-bottom: 3px;
        }
        
        .npc-status {
            margin-top: 10px;
            padding: 8px;
            background-color: #1a1a1a;
            border-radius: 5px;
            text-align: center;
        }
        
        .status-item {
            display: inline-block;
            margin: 0 10px;
            font-size: 14px;
            color: #ccc;
        }
        
        .status-value.alive {
            color: #4CAF50;
        }
        
        .status-value.unconscious {
            color: #FF9800;
        }
        
        .status-value.dead {
            color: #f44336;
        }
        
        .npc-inventory-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }
        
        .npc-inventory-modal-content {
            position: relative;
            background-color: #2c2c2c;
            margin: 5% auto;
            padding: 20px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 80%;
            overflow: hidden;
        }
        
        .npc-inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
        }
        
        .npc-inventory-title {
            color: #4CAF50;
            font-size: 20px;
            font-weight: bold;
        }
        
        .npc-inventory-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .npc-inventory-close:hover {
            color: #fff;
        }
        
        .npc-inventory-body {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .npc-inventory-item {
            background-color: #1a1a1a;
            border-radius: 5px;
            padding: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #4CAF50;
        }
        
        .npc-inventory-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .npc-inventory-item-name {
            color: #e0e0e0;
            font-weight: bold;
            font-size: 14px;
        }
        
        .npc-inventory-item-quantity {
            color: #4CAF50;
            font-size: 12px;
            background-color: #333;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .npc-inventory-item-details {
            color: #aaa;
            font-size: 12px;
            margin-top: 4px;
        }
        
        .npc-inventory-item-description {
            color: #ccc;
            font-size: 11px;
            font-style: italic;
            margin-top: 2px;
        }
        
        .condition-value {
            color: #FFA500;
            font-weight: bold;
        }
        
        .npc-spell-info {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding: 8px;
            background-color: #1a1a1a;
            border-radius: 4px;
            border-left: 3px solid #4CAF50;
        }
        
        .npc-spell-stat {
            color: #FFA500;
            font-weight: bold;
            font-size: 14px;
        }
        
        .npc-spell-level {
            margin-bottom: 12px;
            background-color: #1a1a1a;
            border-radius: 4px;
            padding: 8px;
        }
        
        .npc-spell-level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            border-bottom: 1px solid #444;
            padding-bottom: 4px;
        }
        
        .npc-spell-level-name {
            color: #4CAF50;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .npc-spell-slots {
            font-size: 12px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            background-color: #333;
        }
        
        .npc-spell-slots.available {
            color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .npc-spell-slots.low {
            color: #FF9800;
            background-color: rgba(255, 152, 0, 0.1);
        }
        
        .npc-spell-slots.exhausted {
            color: #f44336;
            background-color: rgba(244, 67, 54, 0.1);
        }
        
        .npc-spell-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }
        
        .npc-spell-item {
            color: #e0e0e0;
            font-size: 13px;
            padding: 2px 4px;
            background-color: #333;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .npc-spell-item:hover {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        .character-tabs {
            margin-top: 10px;
        }
        
        .tab-nav {
            display: flex;
            background-color: #1a1a1a;
            border-radius: 5px 5px 0 0;
            overflow: hidden;
            border: 1px solid #555;
            border-bottom: none;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
    </style>
</head>
<body>
    <div class="header">
        <h1>DungeonMasterAI</h1>
        <div class="location-info" id="location-info">
            <div class="location-name" id="location-name">Loading location...</div>
            <div class="location-details" id="location-details"></div>
        </div>
        <div class="status">
            <span id="status-text">Disconnected</span>
            <div class="status-indicator" id="status-indicator"></div>
            <button class="start-button" id="start-button" onclick="startGame()">Start Game</button>
            <div class="save-load-buttons">
                <button class="save-button" id="save-button" onclick="openSaveDialog()" disabled title="Save Game">Save</button>
                <button class="load-button" id="load-button" onclick="openLoadDialog()" disabled title="Load Game">Load</button>
            </div>
        </div>
    </div>
    
    <div class="main-container">
        <div class="panel game-panel">
            <div class="panel-header">
                <span>Game Output</span>
                <!-- Dice Rolling Strip -->
                <div class="dice-strip-inline">
                    <span class="dice-label">Quick Rolls:</span>
                    <button class="dice-button" onclick="rollDice(20)" title="Roll D20">D20</button>
                    <button class="dice-button" onclick="rollDice(12)" title="Roll D12">D12</button>
                    <button class="dice-button" onclick="rollDice(10)" title="Roll D10">D10</button>
                    <button class="dice-button" onclick="rollDice(8)" title="Roll D8">D8</button>
                    <button class="dice-button" onclick="rollDice(6)" title="Roll D6">D6</button>
                    <button class="dice-clear-button" onclick="clearDiceResults()" title="Clear results">Clear</button>
                </div>
            </div>
            
            <!-- Dice Results Area -->
            <div class="dice-results" id="dice-results" style="display: none;"></div>
            
            <div class="panel-content" id="game-output"></div>
            <div class="input-container">
                <input 
                    type="text" 
                    class="input-field" 
                    id="user-input" 
                    placeholder="Enter your command..."
                    disabled
                    onkeypress="handleKeyPress(event)"
                />
                <button class="send-button" id="send-button" onclick="sendInput()" disabled>Send</button>
            </div>
        </div>
        
        <div class="panel debug-panel">
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('stats')">Character</button>
                <button class="tab-button" onclick="switchTab('inventory')">Inventory</button>
                <button class="tab-button" onclick="switchTab('spells')">Spells & Magic</button>
                <button class="tab-button" onclick="switchTab('npcs')">NPCs</button>
                <button class="tab-button" onclick="switchTab('debug')">Debug</button>
            </div>
            <div class="tab-content" id="debug-tab" style="display: none;">
                <div class="panel-content" id="debug-output"></div>
            </div>
            <div class="tab-content" id="inventory-tab" style="display: none;">
                <div class="panel-content" id="inventory-content">
                    <div class="loading">Loading inventory...</div>
                </div>
            </div>
            <div class="tab-content" id="stats-tab" style="display: block;">
                <div class="panel-content" id="stats-content">
                    <div class="loading">Loading character stats...</div>
                </div>
            </div>
            <div class="tab-content" id="spells-tab" style="display: none;">
                <div class="panel-content" id="spells-content">
                    <div class="loading">Loading spells and magic items...</div>
                </div>
            </div>
            <div class="tab-content" id="npcs-tab" style="display: none;">
                <div class="panel-content" id="npcs-content">
                    <div class="loading">Loading NPC information...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const socket = io();
        let connected = false;
        let gameStarted = false;
        
        // Capitalize first letter of each word function
        function capitalizeWords(str) {
            if (!str) return str;
            return str.replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // Auto-scroll to bottom function
        function scrollToBottom(contentElementId) {
            const contentElement = document.getElementById(contentElementId);
            if (!contentElement) return;

            let scrollableElement = (contentElementId === 'debug-output') ? contentElement.parentElement : contentElement;

            if (scrollableElement) {
                setTimeout(() => {
                    scrollableElement.scrollTop = scrollableElement.scrollHeight;
                }, 50);
            }
        }
        
        // Format timestamp
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString();
        }
        
        // Add message to output with Tavern AI style
        function addMessage(outputId, message) {
            const output = document.getElementById(outputId);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.type}`;
            
            // Handle different message types
            if (message.type === 'narration') {
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                const avatarImg = document.createElement('img');
                avatarImg.src = '/static/dm_logo.png';
                avatarImg.alt = 'DM';
                avatar.appendChild(avatarImg);
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                const header = document.createElement('div');
                header.className = 'message-header';
                const author = document.createElement('span');
                author.className = 'message-author';
                author.textContent = 'Dungeon Master';
                const badge = document.createElement('span');
                badge.className = 'message-badge';
                badge.textContent = 'DM';
                const text = document.createElement('div');
                text.className = 'message-text';
                text.textContent = message.content;
                header.appendChild(author);
                header.appendChild(badge);
                contentDiv.appendChild(header);
                contentDiv.appendChild(text);
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentDiv);
                
            } else if (message.type === 'user-input') {
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = '⚔️';
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                const header = document.createElement('div');
                header.className = 'message-header';
                const author = document.createElement('span');
                author.className = 'message-author';
                author.textContent = 'You';
                const text = document.createElement('div');
                text.className = 'message-text';
                text.textContent = message.content;
                header.appendChild(author);
                contentDiv.appendChild(header);
                contentDiv.appendChild(text);
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentDiv);
                
            } else if (message.type === 'system' || message.type === 'error') {
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                const text = document.createElement('div');
                text.className = 'message-text';
                text.textContent = message.content;
                contentDiv.appendChild(text);
                messageDiv.appendChild(contentDiv);
                
            } else if (message.type === 'debug') {
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                if (message.timestamp && outputId === 'debug-output') {
                    const timestamp = document.createElement('span');
                    timestamp.className = 'timestamp';
                    timestamp.textContent = formatTimestamp(message.timestamp);
                    contentDiv.appendChild(timestamp);
                }
                const text = document.createElement('div');
                text.className = 'message-text';
                text.textContent = message.content;
                contentDiv.appendChild(text);
                messageDiv.appendChild(contentDiv);
            }
            
            output.appendChild(messageDiv);
            scrollToBottom(outputId);
        }
        
        // Socket event handlers
        socket.on('connect', () => {
            connected = true;
            document.getElementById('status-text').textContent = 'Connected';
            document.getElementById('status-indicator').classList.add('connected');
            loadCharacterStats();
        });
        
        socket.on('disconnect', () => {
            connected = false;
            gameStarted = false;
            document.getElementById('status-text').textContent = 'Disconnected';
            document.getElementById('status-indicator').classList.remove('connected');
            document.getElementById('user-input').disabled = true;
            document.getElementById('send-button').disabled = true;
        });
        
        socket.on('game_started', (data) => {
            gameStarted = true;
            document.getElementById('start-button').textContent = 'Game Running';
            document.getElementById('start-button').disabled = true;
            document.getElementById('user-input').disabled = false;
            document.getElementById('send-button').disabled = false;
            document.getElementById('save-button').disabled = false;
            document.getElementById('load-button').disabled = false;
            document.getElementById('user-input').focus();
            addMessage('game-output', { type: 'system', content: 'Game started! You can now enter commands.' });
            loadCharacterStats();
            loadLocationData();
        });
        
        socket.on('game_output', (message) => { addMessage('game-output', message); });
        socket.on('debug_output', (message) => { addMessage('debug-output', message); });
        socket.on('error', (error) => { addMessage('game-output', { type: 'error', content: error.message }); });
        
        socket.on('status_update', (data) => {
            const input = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            if (data.is_processing) {
                input.placeholder = data.message;
                input.disabled = true;
                sendButton.disabled = true;
            } else {
                input.placeholder = "Enter your command...";
                input.disabled = false;
                sendButton.disabled = false;
                input.focus();
            }
        });
        
        // User interaction functions
        function startGame() {
            if (connected && !gameStarted) {
                socket.emit('start_game');
            }
        }
        
        function sendInput() {
            const input = document.getElementById('user-input');
            const value = input.value.trim();
            if (value && connected && gameStarted) {
                socket.emit('user_input', { input: value });
                input.value = '';
                input.focus();
            }
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendInput();
            }
        }
        
        // Tab switching function
        function switchTab(tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => { tab.style.display = 'none'; });
            
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => { button.classList.remove('active'); });
            
            document.getElementById(`${tabName}-tab`).style.display = 'block';
            event.target.classList.add('active');
            
            if (tabName === 'inventory') loadInventory();
            else if (tabName === 'stats') loadCharacterStats();
            else if (tabName === 'spells') loadSpellsAndMagic();
            else if (tabName === 'npcs') loadNPCs();
        }
        
        function loadInventory() { socket.emit('request_player_data', { dataType: 'inventory' }); }
        function loadCharacterStats() { socket.emit('request_player_data', { dataType: 'stats' }); }
        function loadSpellsAndMagic() { socket.emit('request_player_data', { dataType: 'inventory' }); }
        function loadNPCs() { socket.emit('request_player_data', { dataType: 'npcs' }); }
        function loadLocationData() { socket.emit('request_location_data'); }
        
        // Display inventory data
        let originalInventoryData = null;
        function displayInventory(data, preserveOriginal = false) {
            const container = document.getElementById('inventory-content');
            if (!data) {
                container.innerHTML = '<div class="loading">No inventory data available</div>';
                return;
            }
            const hasCustomSort = currentSort !== 'name-asc';
            if (!preserveOriginal && originalInventoryData && (filtersActive || hasCustomSort)) {
                originalInventoryData = data;
                applyFiltersAndSort();
                return;
            }
            if (!preserveOriginal) {
                originalInventoryData = data;
            }
            let html = '<div class="inventory-sheet">';
            if (data.currency) {
                html += `<div class="inventory-header"><div class="currency-display"><div class="currency-title">Currency</div><div class="currency-grid"><div class="currency-item"><span class="currency-amount">${data.currency.gold || 0}</span><span class="currency-type">GP</span></div><div class="currency-item"><span class="currency-amount">${data.currency.silver || 0}</span><span class="currency-type">SP</span></div><div class="currency-item"><span class="currency-amount">${data.currency.copper || 0}</span><span class="currency-type">CP</span></div></div></div></div>`;
            }
            html += `<div class="inventory-controls"><button class="search-btn" onclick="openSearchPopup()">Search</button><select class="inventory-sort" id="inventory-sort" onchange="sortInventory()"><option value="name-asc">Sort: Name A-Z</option><option value="name-desc">Sort: Name Z-A</option><option value="type">Sort: Type</option><option value="quantity">Sort: Quantity</option></select><select class="filter-dropdown" id="filter-dropdown" onchange="changeFilter()"><option value="">Filter</option><option value="weapon">Weapons</option><option value="armor">Armor</option><option value="consumable">Consumables</option><option value="magical">Magical</option><option value="equipped">Equipped</option></select><button class="search-btn" onclick="clearAllFilters()">Clear</button></div>`;
            html += '<div class="equipment-section"><h4>Equipment</h4>';
            if (data.equipment && data.equipment.length > 0) {
                data.equipment.forEach(item => { html += `<div class="inventory-item" title="${(item.description || '').substr(0, 80)}"><span class="feature-bullet">●</span><span class="item-name">${item.item_name}${(item.quantity||1) > 1 ? ` ×${item.quantity}` : ''}</span><span class="item-type"> (${(item.item_type || 'misc').toLowerCase()})</span></div>`; });
            } else {
                html += '<div class="inventory-item"><span class="feature-bullet">●</span><span class="item-name">No equipment</span></div>';
            }
            html += '</div><div class="inventory-sections">';
            if (data.attacksAndSpellcasting && data.attacksAndSpellcasting.length > 0) {
                html += '<div class="inventory-section"><h4>Weapons & Attacks</h4>';
                data.attacksAndSpellcasting.forEach(weapon => { html += `<div class="inventory-item" title="${weapon.description || ''}"><div class="item-main"><span class="item-name">${weapon.name}</span><span class="weapon-bonus">${weapon.attackBonus >= 0 ? '+' : ''}${weapon.attackBonus}</span></div><div class="item-details"><span class="weapon-damage">Damage: ${weapon.damage || `${weapon.damageDice}+${weapon.damageBonus}`} (${weapon.damageType || 'damage'})</span></div></div>`; });
                html += '</div>';
            }
            if (data.ammunition && data.ammunition.length > 0) {
                html += '<div class="inventory-section"><h4>Ammunition</h4>';
                data.ammunition.forEach(ammo => { html += `<div class="inventory-item" title="${ammo.description || ''}"><div class="item-main"><span class="item-name">${ammo.name}</span><span class="item-qty">×${ammo.quantity}</span></div></div>`; });
                html += '</div>';
            }
            html += '</div></div>';
            container.innerHTML = html;
            const sortDropdown = document.getElementById('inventory-sort');
            const filterDropdown = document.getElementById('filter-dropdown');
            if (sortDropdown && currentSort) sortDropdown.value = currentSort;
            if (filterDropdown && currentFilter) filterDropdown.value = currentFilter;
        }
        
        // Display character stats
        function displayCharacterStats(data) {
            const container = document.getElementById('stats-content');
            if (!data) {
                container.innerHTML = '<div class="loading">No character data available</div>';
                return;
            }
            function getModifier(score) { const mod = Math.floor((score - 10) / 2); return mod >= 0 ? `+${mod}` : `${mod}`; }
            const hpPercent = (data.hitPoints / data.maxHitPoints) * 100;
            let hpClass = '';
            if (hpPercent <= 25) hpClass = 'low'; else if (hpPercent <= 50) hpClass = 'medium';
            let html = '<div class="character-sheet">';
            html += `<div class="character-header"><div class="character-name">${data.name}</div><div class="character-details"><div class="detail-left"><div><span class="orange">Level ${data.level}</span> ${data.race} ${data.class}</div><div><span class="orange">Profession:</span> ${data.background || 'Adventurer'} • <span class="orange">Alignment:</span> ${capitalizeWords(data.alignment) || 'Neutral'}</div></div><div class="detail-right"><div><span class="orange">XP:</span> ${data.experience_points} / ${data.exp_required_for_next_level}</div><div><span class="orange">Status:</span> ${capitalizeWords(data.status) || 'Alive'} • <span class="orange">Prof:</span> +${data.proficiencyBonus || 2}</div></div></div></div>`;
            if (data.abilities) {
                html += '<div class="abilities-row">';
                ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'].forEach(ability => {
                    const score = data.abilities[ability] || 10;
                    html += `<div class="ability-score"><div class="ability-name">${ability.substr(0, 3).toUpperCase()}</div><div class="ability-value">${score}</div><div class="ability-modifier">${getModifier(score)}</div></div>`;
                });
                html += '</div>';
            }
            html += `<div class="combat-stats"><div class="combat-stat"><div class="combat-stat-label">Hit Points</div><div class="combat-stat-value">${data.hitPoints}/${data.maxHitPoints}</div><div class="hp-bar"><div class="hp-fill ${hpClass}" style="width: ${hpPercent}%"></div></div></div><div class="combat-stat"><div class="combat-stat-label">Armor Class</div><div class="combat-stat-value">${data.armorClass}</div></div><div class="combat-stat"><div class="combat-stat-label">Initiative</div><div class="combat-stat-value">${data.initiative >= 0 ? '+' : ''}${data.initiative}</div></div></div>`;
            html += '<div class="skills-saves-container">';
            if (data.savingThrows && data.savingThrows.length > 0) {
                html += '<div class="stat-group"><h4>Saving Throws</h4><div class="stat-group-content">';
                ['Strength', 'Dexterity', 'Constitution', 'Intelligence', 'Wisdom', 'Charisma'].forEach(save => {
                    const isProficient = data.savingThrows.includes(save);
                    const abilityMod = data.abilities ? Math.floor((data.abilities[save.toLowerCase()] - 10) / 2) : 0;
                    const bonus = isProficient ? abilityMod + (data.proficiencyBonus || 2) : abilityMod;
                    html += `<div class="save-item"><span class="save-name">${save} ${isProficient ? '●' : '○'}</span><span class="save-value">${bonus >= 0 ? '+' : ''}${bonus}</span></div>`;
                });
                html += '</div></div>';
            }
            if (data.skills) {
                html += '<div class="stat-group"><h4>Skills</h4><div class="stat-group-content">';
                Object.entries(data.skills).forEach(([skill, value]) => { html += `<div class="skill-item"><span class="skill-name">${skill}</span><span class="skill-value">${value >= 0 ? '+' : ''}${value}</span></div>`; });
                html += '</div></div>';
            }
            html += '</div>';
            html += '<div class="abilities-grid">';
            if (data.classFeatures && data.classFeatures.length > 0) {
                html += '<div class="stat-group"><h4>Class Features</h4><div class="stat-group-content">';
                data.classFeatures.forEach(feature => {
                    let usageDisplay = '';
                    if (feature.usage && feature.usage.current !== undefined && feature.usage.max > 0) {
                        usageDisplay = ` <span class="usage-counter ${feature.usage.current === 0 ? 'exhausted' : ''}">${feature.usage.current}/${feature.usage.max}</span>`;
                    }
                    html += `<div class="feature-item" title="${(feature.description || '').replace(/"/g, '&quot;')}"><span class="feature-name">${feature.name}</span>${usageDisplay}${(feature.usage && feature.usage.refreshOn) ? ` <span class="feature-refresh">(${feature.usage.refreshOn})</span>` : ''}</div>`;
                });
                html += '</div></div>';
            }
            if (data.temporaryEffects && data.temporaryEffects.length > 0) {
                html += '<div class="stat-group"><h4>Active Effects</h4><div class="stat-group-content">';
                data.temporaryEffects.forEach(effect => {
                    let durationDisplay = effect.duration ? ` <span class="effect-duration">${effect.duration}</span>` : '';
                    html += `<div class="feature-item" title="${(effect.description || '').replace(/"/g, '&quot;')}"><div class="feature-header"><span class="feature-name">${effect.name}</span>${durationDisplay}</div></div>`;
                });
                html += '</div></div>';
            }
            if (data.racialTraits && data.racialTraits.length > 0) {
                const specialTraits = data.racialTraits.filter(trait => !['Ability Score Increase', 'Languages', 'Extra Language'].includes(trait.name));
                if (specialTraits.length > 0) {
                    html += '<div class="stat-group"><h4>Racial Traits</h4><div class="stat-group-content">';
                    specialTraits.forEach(trait => { html += `<div class="feature-item" title="${(trait.description || '').replace(/"/g, '&quot;')}"><span class="feature-name">${trait.name}</span></div>`; });
                    html += '</div></div>';
                }
            }
            if (data.backgroundFeature && data.backgroundFeature.name) {
                html += `<div class="stat-group"><h4>Background</h4><div class="stat-group-content"><div class="feature-item" title="${(data.backgroundFeature.description || '').replace(/"/g, '&quot;')}"><span class="feature-name">${data.backgroundFeature.name}</span></div></div></div>`;
            }
            if (data.feats && data.feats.length > 0) {
                html += '<div class="stat-group"><h4>Feats</h4><div class="stat-group-content">';
                data.feats.forEach(feat => { html += `<div class="feature-item" title="${(feat.description || '').replace(/"/g, '&quot;')}"><span class="feature-name">${feat.name}</span></div>`; });
                html += '</div></div>';
            }
            html += '</div></div>';
            container.innerHTML = html;
        }
        
        // Display spells and magic items
        function displaySpellsAndMagic(data) {
            const container = document.getElementById('spells-content');
            if (!data) { container.innerHTML = '<div class="loading">No character data available</div>'; return; }
            let html = '<div class="spells-magic-sheet">';
            const hasSpellcasting = data.spellcasting && data.spellcasting.spells && Object.values(data.spellcasting.spells).some(s => Array.isArray(s) && s.length > 0);
            if (hasSpellcasting) {
                html += '<div class="spellcasting-section"><h3>SPELLCASTING</h3>';
                if (data.spellcasting.spellSaveDC || data.spellcasting.spellAttackBonus) { html += `<div class="spell-stats">${data.spellcasting.spellSaveDC ? `<span>Save DC: ${data.spellcasting.spellSaveDC}</span>` : ''}${data.spellcasting.spellAttackBonus ? `<span>Spell Attack: +${data.spellcasting.spellAttackBonus}</span>` : ''}</div>`; }
                const spellLevels = ['cantrips', 'level1', 'level2', 'level3', 'level4', 'level5', 'level6', 'level7', 'level8', 'level9'];
                const spellLevelNames = ['Cantrips', '1st Level', '2nd Level', '3rd Level', '4th Level', '5th Level', '6th Level', '7th Level', '8th Level', '9th Level'];
                spellLevels.forEach((level, index) => {
                    const spells = data.spellcasting.spells[level];
                    if (spells && spells.length > 0) {
                        html += `<div class="spell-level-group"><div class="spell-level-header"><span class="spell-level-name">${spellLevelNames[index]}</span>`;
                        if (index > 0 && data.spellcasting.spellSlots && data.spellcasting.spellSlots[`level${index}`]) {
                            const slots = data.spellcasting.spellSlots[`level${index}`];
                            const slotClass = slots.current === 0 ? 'exhausted' : slots.current <= slots.max * 0.5 ? 'low' : 'available';
                            html += `<span class="spell-slots ${slotClass}">${slots.current || 0}/${slots.max || 0} slots</span>`;
                        }
                        html += '</div><div class="spell-list">';
                        spells.forEach(spellName => {
                            html += `<div class="spell-item"><span class="spell-name">${spellName}</span><div class="spell-badges">${data.spellcasting.preparedSpells && data.spellcasting.preparedSpells.includes(spellName) ? '<span class="spell-badge prepared">P</span>' : ''}</div></div>`;
                        });
                        html += '</div></div>';
                    }
                });
                html += '</div>';
            } else {
                html += '<div class="no-spellcasting-message">This character does not have spellcasting abilities.</div>';
            }
            html += '<div class="magic-items-section">';
            const scrolls = data.equipment ? data.equipment.filter(i => i.item_subtype === 'scroll') : [];
            const potions = data.equipment ? data.equipment.filter(i => i.item_subtype === 'potion') : [];
            const magicalItems = data.equipment ? data.equipment.filter(i => i.magical && !['scroll', 'potion'].includes(i.item_subtype)) : [];
            if (scrolls.length > 0) {
                html += '<div class="magic-items-category"><h4>SCROLLS</h4>';
                scrolls.forEach(s => { html += `<div class="magic-item"><span class="magic-item-name">${s.item_name}</span>${s.spellLevel !== undefined ? `<span class="spell-badge">${s.spellLevel === 0 ? 'Cantrip' : `Level ${s.spellLevel}`}</span>` : ''}${s.quantity > 1 ? `<span class="magic-item-charges">×${s.quantity}</span>` : s.consumable ? '<span class="magic-item-charges consumable">[1x]</span>' : ''}</div>`; });
                html += '</div>';
            }
            if (potions.length > 0) {
                html += '<div class="magic-items-category"><h4>POTIONS</h4>';
                potions.forEach(p => { html += `<div class="magic-item"><span class="magic-item-name">${p.item_name}</span>${p.quantity > 1 ? `<span class="magic-item-charges">×${p.quantity}</span>` : p.consumable ? '<span class="magic-item-charges consumable">[1x]</span>' : ''}</div>`; });
                html += '</div>';
            }
            if (magicalItems.length > 0) {
                html += '<div class="magic-items-category"><h4>MAGIC ITEMS</h4>';
                magicalItems.forEach(item => {
                    let chargesHtml = '';
                    if (item.charges) {
                        const chargeClass = item.charges.current === 0 ? 'exhausted' : item.charges.current <= item.charges.max * 0.5 ? 'low' : 'available';
                        chargesHtml = `<span class="magic-item-charges ${chargeClass}">${item.charges.current || 0}/${item.charges.max || 0}</span>`;
                    }
                    html += `<div class="magic-item"><span class="magic-item-name">${item.item_name}</span>${chargesHtml}</div>`;
                });
                html += '</div>';
            }
            if (scrolls.length === 0 && potions.length === 0 && magicalItems.length === 0) {
                html += '<div class="magic-items-category"><h4>MAGIC ITEMS</h4><div class="magic-item"><span class="magic-item-name">No magical items found</span></div></div>';
            }
            html += '</div></div>';
            container.innerHTML = html;
            
            // Initialize spell tooltips after content is loaded
            initializeSpellTooltips();
        }
        
        // Display NPC information
        function displayNPCs(data) {
            const container = document.getElementById('npcs-content');
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="loading">No NPC data available</div>';
                return;
            }
            
            let html = '';
            data.forEach(npc => {
                const hpPercent = Math.max(0, (npc.hitPoints / npc.maxHitPoints) * 100);
                const hpClass = hpPercent > 75 ? 'healthy' : hpPercent > 50 ? 'injured' : hpPercent > 25 ? 'bloodied' : 'critical';
                
                html += `<div class="npc-character-sheet">`;
                
                html += `<div class="npc-header">`;
                html += `<div class="npc-header-main"><div class="npc-name">${npc.name}</div><div class="npc-details">${npc.race} ${npc.class} • Level ${npc.level} • ${capitalizeWords(npc.alignment)}</div></div>`;
                if (npc.currency) {
                    html += `<div class="npc-header-currency"><div class="currency-grid"><div class="currency-item"><span class="currency-amount">${npc.currency.gold || 0}</span><span class="currency-type">GP</span></div><div class="currency-item"><span class="currency-amount">${npc.currency.silver || 0}</span><span class="currency-type">SP</span></div><div class="currency-item"><span class="currency-amount">${npc.currency.copper || 0}</span><span class="currency-type">CP</span></div></div></div>`;
                }
                html += `</div>`;
                
                if (npc.abilities) {
                    html += '<div class="npc-abilities">';
                    html += `<div class="ability-score npc-combat-stat"><div class="ability-name">HP</div><div class="ability-value">${npc.hitPoints}/${npc.maxHitPoints}</div><div class="hp-bar"><div class="hp-fill ${hpClass}" style="width: ${hpPercent}%"></div></div></div>`;
                    html += `<div class="ability-score npc-combat-stat npc-no-circle"><div class="ability-name">AC</div><div class="ability-value">${npc.armorClass}</div></div>`;
                    html += `<div class="ability-score npc-combat-stat npc-no-circle"><div class="ability-name">INIT</div><div class="ability-value">${npc.initiative >= 0 ? '+' : ''}${npc.initiative}</div></div>`;
                    
                    const allAbilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
                    allAbilities.forEach(ability => {
                        if (npc.abilities[ability]) {
                            const score = npc.abilities[ability];
                            const modifier = Math.floor((score - 10) / 2);
                            html += `<div class="ability-score"><div class="ability-name">${ability.substr(0, 3).toUpperCase()}</div><div class="ability-value">${score}</div><div class="ability-modifier">${modifier >= 0 ? `+${modifier}` : modifier}</div></div>`;
                        }
                    });
                    html += '</div>';
                }
                
                html += '<div class="npc-skills-saves-container">';
                
                if (npc.savingThrows && npc.savingThrows.length > 0) {
                    const savesData = ['Strength', 'Dexterity', 'Constitution', 'Intelligence', 'Wisdom', 'Charisma'].map(save => {
                        const isProficient = npc.savingThrows.includes(save);
                        const abilityMod = npc.abilities ? Math.floor((npc.abilities[save.toLowerCase()] - 10) / 2) : 0;
                        const bonus = isProficient ? abilityMod + (npc.proficiencyBonus || 3) : abilityMod;
                        return { name: save, proficient: isProficient, bonus: bonus >= 0 ? `+${bonus}` : `${bonus}` };
                    });
                    html += `<button class="npc-detail-button" onclick="showNPCSaves('${npc.name}', ${JSON.stringify(savesData).replace(/"/g, '&quot;')})">Saving Throws</button>`;
                }
                
                if (npc.skills) {
                    let skillsData = Object.entries(npc.skills).map(([skill, value]) => ({ name: skill, bonus: value >= 0 ? `+${value}` : `${value}` }));
                    html += `<button class="npc-detail-button" onclick="showNPCSkills('${npc.name}', ${JSON.stringify(skillsData).replace(/"/g, '&quot;')})">Skills</button>`;
                }
                
                if (npc.equipment && npc.equipment.length > 0) {
                    html += `<button class="npc-detail-button" onclick="showNPCInventory('${npc.name}', ${JSON.stringify(npc.equipment).replace(/"/g, '&quot;')})">Inventory</button>`;
                }

                if (npc.classFeatures && npc.classFeatures.length > 0) {
                    const featuresData = npc.classFeatures.map(f => ({ name: f.name, detail: f.description || '' }));
                    html += `<button class="npc-detail-button" onclick="showNPCDetailList('${npc.name}', 'Key Abilities', ${JSON.stringify(featuresData).replace(/"/g, '&quot;')})">Key Abilities</button>`;
                }

                if (npc.racialTraits && npc.racialTraits.length > 0) {
                    const traitsData = npc.racialTraits.map(t => ({ name: t.name, detail: t.description || '' }));
                    html += `<button class="npc-detail-button" onclick="showNPCDetailList('${npc.name}', 'Racial Traits', ${JSON.stringify(traitsData).replace(/"/g, '&quot;')})">Racial Traits</button>`;
                }

                if (npc.backgroundFeature && npc.backgroundFeature.name) {
                    const backgroundData = [{ name: npc.backgroundFeature.name, detail: npc.backgroundFeature.description || '' }];
                    html += `<button class="npc-detail-button" onclick="showNPCDetailList('${npc.name}', 'Background', ${JSON.stringify(backgroundData).replace(/"/g, '&quot;')})">Background</button>`;
                }
                
                html += '</div>';
                
                if (npc.status !== 'alive' || npc.condition !== 'none') {
                    html += `<div class="npc-status"><div class="status-item">Status: <span class="status-value ${npc.status}">${npc.status}</span></div>`;
                    if (npc.condition !== 'none') { html += `<div class="status-item">Condition: <span class="condition-value">${npc.condition}</span></div>`; }
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        function displayLocationData(data) {
            const locationName = document.getElementById('location-name');
            const locationDetails = document.getElementById('location-details');
            if (!data) {
                locationName.textContent = 'Location Unknown';
                locationDetails.textContent = '';
                return;
            }
            locationName.textContent = `${data.currentLocation} (${data.currentArea})`;
            const timeStr = data.time ? `${data.day} ${data.month} ${data.year} - ${data.time}` : 'Time Unknown';
            const idStr = data.currentLocationId ? `[${data.currentAreaId}:${data.currentLocationId}]` : '';
            locationDetails.textContent = `${timeStr} ${idStr}`;
        }
        
        socket.on('player_data_response', (response) => {
            if (response.dataType === 'inventory') {
                const activeTab = document.querySelector('.tab-button.active')?.textContent.toLowerCase();
                if (activeTab === 'spells & magic') {
                    displaySpellsAndMagic(response.data);
                } else {
                    displayInventory(response.data);
                }
            } else if (response.dataType === 'stats') {
                displayCharacterStats(response.data);
            } else if (response.dataType === 'spells') {
                displaySpellsAndMagic(response.data);
            } else if (response.dataType === 'npcs') {
                displayNPCs(response.data);
            }
        });
        
        socket.on('location_data_response', (response) => { displayLocationData(response.data); });
        
        setInterval(() => {
            loadLocationData();
            const activeTab = document.querySelector('.tab-button.active')?.textContent.toLowerCase();
            if (activeTab === 'inventory') loadInventory();
            else if (activeTab === 'character') loadCharacterStats();
            else if (activeTab === 'spells & magic') loadSpellsAndMagic();
            else if (activeTab === 'npcs') loadNPCs();
        }, 5000);
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('user-input').focus();
            loadLocationData();
            if (connected) {
                loadCharacterStats();
            }
        });
        
        function showNPCDetailList(npcName, modalTitle, itemsData) {
            const modal = document.getElementById('npc-details-modal');
            const title = document.getElementById('npc-details-title');
            const body = document.getElementById('npc-details-body');

            title.textContent = `${npcName}'s ${modalTitle}`;
            
            let html = '';
            if (itemsData && itemsData.length > 0) {
                itemsData.forEach(item => {
                    const detailText = item.detail ? `title="${item.detail.replace(/"/g, '&quot;')}"` : '';
                    html += `<div class="npc-details-item" ${detailText}><span class="npc-details-name">${item.name}</span></div>`;
                });
            } else {
                html = `<div class="npc-details-item">No ${modalTitle.toLowerCase()} available.</div>`;
            }
            
            body.innerHTML = html;
            modal.style.display = 'block';
        }

        function showNPCInventory(npcName, equipment) {
            const modal = document.getElementById('npc-inventory-modal');
            const title = document.getElementById('npc-inventory-title');
            const body = document.getElementById('npc-inventory-body');
            title.textContent = `${npcName}'s Inventory`;
            let html = '';
            if (equipment && equipment.length > 0) {
                equipment.forEach(item => {
                    html += `<div class="npc-inventory-item"><div class="npc-inventory-item-header"><div class="npc-inventory-item-name">${item.item_name}</div><div class="npc-inventory-item-quantity">x${item.quantity || 1}</div></div><div class="npc-inventory-item-details">${item.item_type}</div>`;
                    if (item.description) { html += `<div class="npc-inventory-item-description">${item.description}</div>`; }
                    html += '</div>';
                });
            } else { html = '<div class="npc-inventory-item">No items in inventory.</div>'; }
            body.innerHTML = html;
            modal.style.display = 'block';
        }
        
        function closeNPCInventory() { document.getElementById('npc-inventory-modal').style.display = 'none'; }
        
        function showNPCSkills(npcName, skillsData) {
            const modal = document.getElementById('npc-details-modal');
            const title = document.getElementById('npc-details-title');
            const body = document.getElementById('npc-details-body');
            title.textContent = `${npcName}'s Skills`;
            let html = '';
            if (skillsData && skillsData.length > 0) {
                skillsData.forEach(skill => { html += `<div class="npc-details-item"><span class="npc-details-name">${skill.name}</span><span class="npc-details-bonus">${skill.bonus}</span></div>`; });
            } else { html = '<div class="npc-details-item">No skills available.</div>'; }
            body.innerHTML = html;
            modal.style.display = 'block';
        }
        
        function showNPCSaves(npcName, savesData) {
            const modal = document.getElementById('npc-details-modal');
            const title = document.getElementById('npc-details-title');
            const body = document.getElementById('npc-details-body');
            title.textContent = `${npcName}'s Saving Throws`;
            let html = '';
            if (savesData && savesData.length > 0) {
                savesData.forEach(save => { html += `<div class="npc-details-item"><span class="npc-details-name">${save.name} ${save.proficient ? '●' : '○'}</span><span class="npc-details-bonus">${save.bonus}</span></div>`; });
            } else { html = '<div class="npc-details-item">No saving throws available.</div>'; }
            body.innerHTML = html;
            modal.style.display = 'block';
        }
        
        function showNPCSpells(npcName, spellsData) {
            const modal = document.getElementById('npc-details-modal');
            const title = document.getElementById('npc-details-title');
            const body = document.getElementById('npc-details-body');
            title.textContent = `${npcName}'s Spellcasting`;
            let html = '';
            if (spellsData.spellSaveDC || spellsData.spellAttackBonus) { html += `<div class="npc-spell-info">${spellsData.spellSaveDC ? `<span class="npc-spell-stat">Save DC: ${spellsData.spellSaveDC}</span>` : ''}${spellsData.spellAttackBonus ? `<span class="npc-spell-stat">Attack: +${spellsData.spellAttackBonus}</span>` : ''}</div>`; }
            if (spellsData && spellsData.spellsByLevel && spellsData.spellsByLevel.length > 0) {
                spellsData.spellsByLevel.forEach(levelData => {
                    html += `<div class="npc-spell-level"><div class="npc-spell-level-header"><span class="npc-spell-level-name">${levelData.level}</span>`;
                    if (levelData.levelNum > 0 && levelData.slots) {
                        const slotClass = levelData.slots.current === 0 ? 'exhausted' : levelData.slots.current <= levelData.slots.max * 0.5 ? 'low' : 'available';
                        html += `<span class="npc-spell-slots ${slotClass}">${levelData.slots.current || 0}/${levelData.slots.max || 0} slots</span>`;
                    }
                    html += `</div><div class="npc-spell-list">`;
                    levelData.spells.forEach(spell => { html += `<div class="npc-spell-item">${spell}</div>`; });
                    html += `</div></div>`;
                });
            } else { html = '<div class="npc-details-item">No spells available.</div>'; }
            body.innerHTML = html;
            modal.style.display = 'block';
        }
        
        function closeNPCDetails() { document.getElementById('npc-details-modal').style.display = 'none'; }
        
        let diceRolls = { d20: [], damage: [] };
        function rollDice(sides) {
            const array = new Uint32Array(1);
            crypto.getRandomValues(array);
            const result = (array[0] % sides) + 1;
            if (sides === 20) { diceRolls.d20.push(result); } 
            else { diceRolls.damage.push({sides: sides, result: result}); }
            updateDiceDisplay();
        }
        function updateDiceDisplay() {
            const resultsDiv = document.getElementById('dice-results');
            let html = '';
            if (diceRolls.d20.length > 0) { html += '<span class="dice-result-item">d20: ' + diceRolls.d20.join(', d20: ') + '</span>'; }
            if (diceRolls.damage.length > 0) {
                if (html) html += ' | ';
                html += '<span class="dice-result-item">' + diceRolls.damage.map(r => `d${r.sides}: ${r.result}`).join(', ') + '</span>';
                html += '<span class="dice-total">Total: ' + diceRolls.damage.reduce((sum, r) => sum + r.result, 0) + '</span>';
            }
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = html ? 'block' : 'none';
        }
        function clearDiceResults() { diceRolls.d20 = []; diceRolls.damage = []; updateDiceDisplay(); }
        
        let currentSearchTerm = '', currentFilter = '', filtersActive = false, currentSort = 'name-asc';
        function applyFiltersAndSort() {
            if (!originalInventoryData) return;
            let data = JSON.parse(JSON.stringify(originalInventoryData));
            if (data.equipment && currentSort) {
                data.equipment.sort((a, b) => {
                    switch (currentSort) {
                        case 'name-asc': return a.item_name.localeCompare(b.item_name);
                        case 'name-desc': return b.item_name.localeCompare(a.item_name);
                        case 'type': return a.item_type.localeCompare(b.item_type) || a.item_name.localeCompare(b.item_name);
                        case 'quantity': return (b.quantity || 1) - (a.quantity || 1) || a.item_name.localeCompare(b.item_name);
                        default: return 0;
                    }
                });
            }
            if (data.equipment) {
                data.equipment = data.equipment.filter(item => {
                    const search = !currentSearchTerm || item.item_name.toLowerCase().includes(currentSearchTerm) || (item.description && item.description.toLowerCase().includes(currentSearchTerm)) || item.item_type.toLowerCase().includes(currentSearchTerm);
                    let filter = true;
                    if (currentFilter) {
                        switch (currentFilter) {
                            case 'weapon': filter = item.item_type === 'weapon'; break;
                            case 'armor': filter = item.item_type === 'armor'; break;
                            case 'consumable': filter = item.item_type === 'consumable' || item.consumable; break;
                            case 'magical': filter = item.magical; break;
                            case 'equipped': filter = item.equipped; break;
                        }
                    }
                    return search && filter;
                });
            }
            displayInventory(data, true);
        }
        function sortInventory() { currentSort = document.getElementById('inventory-sort').value; filtersActive = true; applyFiltersAndSort(); }
        function changeFilter() { currentFilter = document.getElementById('filter-dropdown').value; filtersActive = true; applyFiltersAndSort(); }
        function openSearchPopup() { document.getElementById('search-popup').style.display = 'block'; document.getElementById('search-popup-input').focus(); }
        function closeSearchPopup() { document.getElementById('search-popup').style.display = 'none'; }
        function performSearch() { currentSearchTerm = document.getElementById('search-popup-input').value.toLowerCase(); filtersActive = true; applyFiltersAndSort(); }
        function clearAllFilters() {
            currentSearchTerm = ''; currentFilter = ''; currentSort = 'name-asc'; filtersActive = false;
            document.getElementById('search-popup-input').value = '';
            document.getElementById('filter-dropdown').value = '';
            const sortDropdown = document.getElementById('inventory-sort');
            if (sortDropdown) sortDropdown.value = 'name-asc';
            applyFiltersAndSort();
        }
        
        window.onclick = function(event) {
            if (event.target === document.getElementById('npc-inventory-modal')) closeNPCInventory();
            if (event.target === document.getElementById('npc-details-modal')) closeNPCDetails();
            if (event.target === document.getElementById('search-popup')) closeSearchPopup();
        };
        
        window.onkeydown = function(event) {
            if (event.key === 'Escape' && document.getElementById('search-popup').style.display === 'block') {
                closeSearchPopup();
            }
        };
    </script>
    
    <div id="npc-inventory-modal" class="npc-inventory-modal"><div class="npc-inventory-modal-content"><div class="npc-inventory-header"><div id="npc-inventory-title" class="npc-inventory-title"></div><span class="npc-inventory-close" onclick="closeNPCInventory()">&times;</span></div><div id="npc-inventory-body" class="npc-inventory-body"></div></div></div>
    <div id="npc-details-modal" class="npc-details-modal"><div class="npc-details-modal-content"><div class="npc-details-header"><div id="npc-details-title" class="npc-details-title"></div><span class="npc-details-close" onclick="closeNPCDetails()">&times;</span></div><div id="npc-details-body" class="npc-details-body"></div></div></div>
    <div id="search-popup" class="search-popup"><div class="search-popup-content"><div class="search-popup-header"><div class="search-popup-title">Search Inventory</div><span class="search-popup-close" onclick="closeSearchPopup()">&times;</span></div><input type="text" class="search-popup-input" id="search-popup-input" placeholder="Search items..." onkeyup="performSearch()"></div></div>
    <div id="save-dialog-overlay" class="save-dialog-overlay"><div class="save-dialog"><h3>Save Game</h3><div class="save-form"><label for="save-description">Description (optional):</label><textarea id="save-description" placeholder="..."></textarea><label for="save-mode">Save Mode:</label><select id="save-mode"><option value="essential">Essential (faster)</option><option value="full">Full (includes history)</option></select></div><div class="dialog-buttons"><button class="dialog-button secondary" onclick="closeSaveDialog()">Cancel</button><button class="dialog-button primary" onclick="performSave()">Save Game</button></div></div></div>
    <div id="load-dialog-overlay" class="save-dialog-overlay"><div class="save-dialog"><h3>Load Game</h3><div id="save-list" class="save-list"></div><div class="dialog-buttons"><button class="dialog-button secondary" onclick="closeLoadDialog()">Cancel</button><button class="dialog-button danger" onclick="deleteSelectedSave()" id="delete-save-button" disabled>Delete</button><button class="dialog-button primary" onclick="performLoad()" id="load-save-button" disabled>Load Game</button></div></div></div>

    <script>
        let selectedSaveFolder = null;
        function openSaveDialog() { document.getElementById('save-dialog-overlay').style.display = 'flex'; document.getElementById('save-description').focus(); }
        function closeSaveDialog() { document.getElementById('save-dialog-overlay').style.display = 'none'; document.getElementById('save-description').value = ''; document.getElementById('save-mode').value = 'essential'; }
        function openLoadDialog() { document.getElementById('load-dialog-overlay').style.display = 'flex'; loadSaveGameList(); }
        function closeLoadDialog() { document.getElementById('load-dialog-overlay').style.display = 'none'; selectedSaveFolder = null; updateLoadButtons(); }
        function loadSaveGameList() { const saveList = document.getElementById('save-list'); saveList.innerHTML = 'Loading...'; socket.emit('action', { action: 'listSaves', parameters: {} }); }
        function selectSaveGame(saveFolder, element) { document.querySelectorAll('.save-item').forEach(item => { item.classList.remove('selected'); }); element.classList.add('selected'); selectedSaveFolder = saveFolder; updateLoadButtons(); }
        function updateLoadButtons() {
            const disabled = !selectedSaveFolder;
            document.getElementById('load-save-button').disabled = disabled;
            document.getElementById('delete-save-button').disabled = disabled;
        }
        function performSave() {
            const description = document.getElementById('save-description').value;
            const saveMode = document.getElementById('save-mode').value;
            socket.emit('action', { action: 'saveGame', parameters: { description: description, saveMode: saveMode } });
            closeSaveDialog();
        }
        function performLoad() {
            if (!selectedSaveFolder) return;
            if (confirm('Overwrite current progress?')) {
                socket.emit('action', { action: 'restoreGame', parameters: { saveFolder: selectedSaveFolder } });
                closeLoadDialog();
            }
        }
        function deleteSelectedSave() {
            if (!selectedSaveFolder) return;
            if (confirm('Delete this save? This cannot be undone.')) {
                socket.emit('action', { action: 'deleteSave', parameters: { saveFolder: selectedSaveFolder } });
                setTimeout(() => loadSaveGameList(), 500);
                selectedSaveFolder = null;
                updateLoadButtons();
            }
        }
        socket.on('save_list_response', (saveGames) => {
            const saveList = document.getElementById('save-list');
            if (saveGames.length === 0) { saveList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No save games found.</div>'; return; }
            let html = '';
            saveGames.forEach(save => {
                html += `<div class="save-item" onclick="selectSaveGame('${save.save_folder}', this)"><div class="save-item-header">${save.save_folder}</div><div class="save-item-details">Date: ${save.save_date_readable || '?'}<br>Module: ${save.module || '?'}<br>Location: ${save.game_state?.current_location || '?'}<br>Mode: ${save.save_mode || '?'}<br>Description: ${save.description || 'No description'}</div></div>`;
            });
            saveList.innerHTML = html;
        });

        function switchCharacterDetailTab(containerId, tabName) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const panes = container.querySelectorAll(".tab-pane");
            panes.forEach(pane => pane.classList.remove("active"));
            const buttons = container.querySelectorAll(".tab-button");
            buttons.forEach(button => button.classList.remove("active"));
            const selectedPane = container.querySelector(`[data-tab="${tabName}"]`);
            const selectedButton = container.querySelector(`[data-tab-btn="${tabName}"]`);
            if (selectedPane) selectedPane.classList.add("active");
            if (selectedButton) selectedButton.classList.add("active");
        }

        // Spell Tooltip System
        let spellData = null;
        let currentTooltip = null;

        // Load spell data once and cache it
        fetch('/spell-data')
            .then(response => response.json())
            .then(data => {
                spellData = data;
            })
            .catch(error => {
                console.warn('Could not load spell data:', error);
                spellData = {};
            });

        function normalizeSpellName(spellName) {
            return spellName.toLowerCase()
                .replace(/['\s/-]/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_|_$/g, '');
        }

        function createSpellTooltip(spellInfo) {
            const tooltip = document.createElement('div');
            tooltip.className = 'spell-tooltip';
            
            let html = `<div class="spell-tooltip-header">${spellInfo.name}</div>`;
            
            // Meta information
            const components = [];
            if (spellInfo.components?.verbal) components.push('V');
            if (spellInfo.components?.somatic) components.push('S');
            if (spellInfo.components?.material) components.push('M');
            
            const levelText = spellInfo.level === 0 ? 'Cantrip' : `Level ${spellInfo.level}`;
            html += `<div class="spell-tooltip-meta">${levelText} ${spellInfo.school} • ${spellInfo.casting_time} • ${components.join(', ')}</div>`;
            
            // Description
            html += `<div class="spell-tooltip-description">${spellInfo.description}</div>`;
            
            // Classes
            if (spellInfo.classes && spellInfo.classes.length > 0) {
                html += `<div class="spell-tooltip-classes">Classes: ${spellInfo.classes.join(', ')}</div>`;
            }
            
            tooltip.innerHTML = html;
            return tooltip;
        }

        function showSpellTooltip(event) {
            if (!spellData) return;

            const spellNameElement = event.currentTarget;
            const spellName = spellNameElement.textContent.trim();
            const normalizedName = normalizeSpellName(spellName);
            const spellInfo = spellData[normalizedName];

            if (!spellInfo) return;

            hideSpellTooltip(); // Remove any lingering tooltips

            currentTooltip = createSpellTooltip(spellInfo);
            document.body.appendChild(currentTooltip);

            const rect = spellNameElement.getBoundingClientRect();
            const tooltipRect = currentTooltip.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            // Position above the element by default
            let top = rect.top - tooltipRect.height - 8;
            if (top < 8) { // If not enough space above, position below
                top = rect.bottom + 8;
            }

            // Center with the element horizontally
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            if (left < 8) { // Keep on screen horizontally
                left = 8;
            } else if (left + tooltipRect.width > viewportWidth - 8) {
                left = viewportWidth - tooltipRect.width - 8;
            }

            currentTooltip.style.left = `${left}px`;
            currentTooltip.style.top = `${top}px`;

            // Use a timeout to allow the browser to apply the position before adding
            // the 'visible' class, which triggers the CSS transition for a smooth fade-in.
            setTimeout(() => {
                if (currentTooltip) {
                    currentTooltip.classList.add('visible');
                }
            }, 10);
        }

        function hideSpellTooltip() {
            if (currentTooltip) {
                currentTooltip.remove();
                currentTooltip = null;
            }
        }

        function initializeSpellTooltips() {
            // Add event listeners to all spell names
            document.querySelectorAll('.spell-name').forEach(nameElement => {
                nameElement.addEventListener('mouseenter', showSpellTooltip);
                nameElement.addEventListener('mouseleave', hideSpellTooltip);
            });
        }
    </script>
</body>
</html>